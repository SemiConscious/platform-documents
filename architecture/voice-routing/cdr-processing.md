# CDR Processing Pipeline (CDRMunch)

> **Last Updated:** 2026-01-20  
> **Source:** Confluence Design Space, GitHub platform-cdrmunch  
> **Status:** ✅ Complete

---

## Overview

CDRMunch is the **Post Call Processing (PCP)** system responsible for handling Call Detail Records (CDRs) generated by FreeSWITCH. It encompasses multiple components that process, enrich, and distribute call data for billing, analytics, archiving, notifications, and Salesforce integration.

The system is part of a broader PCP infrastructure that includes CDRMunch and the Archiving service (`platform-archiving`), which together handle all aspects of post-call data processing.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           CDR PROCESSING PIPELINE                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   FreeSWITCH PBX                                                                     │
│   ┌─────────────┐                                                                    │
│   │ Call Ends   │                                                                    │
│   │ CDR XML     │─────────┐                                                          │
│   │ Generated   │         │                                                          │
│   └─────────────┘         │                                                          │
│                           ▼                                                          │
│   ┌───────────────────────────────────────────────────────────────────────────────┐  │
│   │                        Archiving CollectD                                     │  │
│   │  • Collects CDR, recordings, PCAP from PBX                                    │  │
│   │  • Sends data to ArchiveD for processing                                      │  │
│   └───────────────────────────────────────────────────┬───────────────────────────┘  │
│                                                       │                              │
│                                                       ▼                              │
│   ┌───────────────────────────────────────────────────────────────────────────────┐  │
│   │                            ArchiveD                                           │  │
│   │  • Stores artifacts (recordings, PCAP, CDR) to local disk                     │  │
│   │  • Queues CDRs for processing via MariaDB queue                               │  │
│   │  • Sends CDRs to CDRMunch Gateway                                             │  │
│   └───────────────────────────────────────────────────┬───────────────────────────┘  │
│                                                       │                              │
│                                                       ▼                              │
│   ┌───────────────────────────────────────────────────────────────────────────────┐  │
│   │                        CDR Gateway (rmcdrgateway)                             │  │
│   │  • Receives CDR XML via FastCGI + Apache                                      │  │
│   │  • Writes to queue database                                                   │  │
│   │  • Stores raw CDR to disk                                                     │  │
│   └───────────────────────────────────────────────────┬───────────────────────────┘  │
│                                                       │                              │
│                                                       ▼                              │
│   ┌───────────────────────────────────────────────────────────────────────────────┐  │
│   │                         CDR Distiller (rmdistiller)                           │  │
│   │  • Polls queue for new CDRs                                                   │  │
│   │  • Normalizes CDR XML using XQuery (Zorba)                                    │  │
│   │  • Generates tasks based on CDR content                                       │  │
│   │  • Writes tasks to QueueDB                                                    │  │
│   └───────────────────────────────────────────────────┬───────────────────────────┘  │
│                                                       │                              │
│                        ┌──────────────────────────────┼──────────────────────────┐   │
│                        ▼                              ▼                          ▼   │
│   ┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────┐  │
│   │   Task Executor        │  │   Billing Feeder        │  │      Hurler         │  │
│   │   (cdrmunch-task-exec) │  │                         │  │   (rmhurler)        │  │
│   │                        │  │                         │  │                     │  │
│   │   • Notifications      │  │   • Billing data        │  │   • Call Analysis   │  │
│   │   • Voicemail          │  │   • Wholesale CDR       │  │   • Sends to AWS S3 │  │
│   │   • Email recordings   │  │                         │  │                     │  │
│   │   • SMS tasks          │  │                         │  │                     │  │
│   └─────────────────────────┘  └─────────────────────────┘  └─────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Details

### 1. CDR Gateway (rmcdrgateway)

**Binary:** `rmcdrgateway.bin`  
**Service:** `rmcdrgateway.service`  
**Language:** C++ (FastCGI)

The gateway is the entry point for CDR data into the processing pipeline.

| Function | Description |
|----------|-------------|
| **CDR Reception** | Receives CDR XML documents via HTTP POST |
| **Queue Management** | Writes CDR entries to the processing queue |
| **Storage** | Writes raw CDR files to disk at configured path |
| **FastCGI** | Runs behind Apache httpd for high-performance HTTP handling |

**Configuration:** `/etc/cdrmunch/rmcdrgateway.conf`

```ini
# Example gateway configuration
gateway.socket_path = /var/run/cdrmunch/rmcdrgateway.sock
gateway.cdr_base_path = /mnt/rmfs/cdr
```

### 2. CDR Distiller (rmdistiller)

**Binary:** `rmdistiller.bin`  
**Service:** `rmdistiller.service`  
**Language:** C++

The distiller is the core processing engine that normalizes CDRs and generates tasks.

| Function | Description |
|----------|-------------|
| **Queue Polling** | Polls the queue database for new CDRs |
| **CDR Normalization** | Transforms raw CDR XML using XQuery (Zorba engine) |
| **Task Generation** | Creates tasks based on CDR content and org configuration |
| **Multi-threaded** | Configurable number of distillery threads |

**Configuration:** `/etc/cdrmunch/rmdistiller.conf`

```ini
# Distiller configuration
gateway.cdr_base_path = /mnt/rmfs/cdr
distiller.number_of_distilleries = 4
distiller.cdr_queue_poll_interval_seconds = 20
distiller.normalized_cdr_base_dir = /var/spool/cdrtmp/cdrmunch-normalized-cdr
distiller.cdr_cache_dir = /var/spool/cdrtmp/cdrmunch-cache
distiller.disabled_tasks = LogActivity,SalesForceStore
```

**XQuery Processing:**
- Uses Zorba XQuery engine for XML transformation
- Normalize script: `/usr/share/cdrmunch/normalize.xq`
- Extracts call metadata, participants, timing, and outcomes

### 3. Task Executor (cdrmunch-task-executor)

**Binary:** `task-executor.php`  
**Service:** `cdrmunch-task-executor.service`  
**Language:** PHP

Executes various post-call tasks generated by the distiller.

| Task Type | Description |
|-----------|-------------|
| **EmailRecording** | Send call recording via email |
| **NotifyVoicemailViaEmail** | Voicemail notification by email |
| **NotifyVoicemailViaSMS** | Voicemail notification by SMS |
| **SendEmail** | Generic email sending |
| **SendSMS** | SMS notification |
| **LogActivity** | Log call activity (disabled by default) |

**Task Classes:**
```
/usr/share/php/cdrmunch/
├── class.EmailRecordingTask.php
├── class.NotifyVoicemailViaEmailTask.php
├── class.NotifyVoicemailViaSMSTask.php
├── class.SendEmailTasks.php
├── class.SendSMSTask.php
├── class.LogActivityTask.php
├── class.PerformableTask.php
└── class.Task.php
```

**SMS Providers:**
- TextMarketer
- MessageBird
- Bandwidth (US A2P 10DLC)
- Auto-select based on region/requirements

### 4. Billing Feeder (cdrmunch-billing-feeder)

**Binary:** `billing-feeder.php`  
**Service:** `cdrmunch-billing-feeder.service`  
**Language:** PHP

Processes CDRs for billing and wholesale data export.

| Function | Description |
|----------|-------------|
| **Billing CDR** | Extracts billing-relevant data from CDRs |
| **Wholesale Feed** | Generates wholesale billing records |
| **UCAR Integration** | Feeds data to usage/billing systems |

### 5. Hurler (rmhurler)

**Binary:** `rmhurler.bin`  
**Service:** `rmhurler.service`  
**Language:** C++

Ships call analysis tasks to AWS for transcription and AI processing.

| Function | Description |
|----------|-------------|
| **Call Analysis** | Sends recordings to AWS S3 for analysis |
| **S3 Upload** | Uploads recordings with metadata |
| **Transcription** | Triggers transcription pipeline |

**Configuration:** `/etc/cdrmunch/rmhurler.conf`

```ini
# Call analysis AWS S3 configuration
call-analysis.aws-s3-bucket = <bucket-name>
call-analysis.aws-s3-access-key = <access-key>
call-analysis.aws-s3-secret-key = <secret-key>
```

**libs3 Integration:**
- Uses libs3 library (version 4.1) for S3 operations
- Includes s3 CLI utility for manual operations

### 6. Emailer Service (cdrmunch-emailer)

**Binary:** `emailer.php`  
**Service:** `cdrmunch-emailer.service`  
**Language:** PHP

Handles email delivery for various notification tasks.

| Function | Description |
|----------|-------------|
| **Recording Emails** | Sends call recordings as attachments |
| **Voicemail Notifications** | Email notifications for voicemails |
| **MP3 Conversion** | Converts WAV to MP3 using LAME |

### 7. Slow Task Executor (rmtaskexslow)

**Service:** `rmtaskexslow.service`

Handles long-running or resource-intensive tasks separately from the main executor.

| Function | Description |
|----------|-------------|
| **Call Log JSON Export** | Exports call logs to JSON format |
| **Large File Processing** | Handles tasks that exceed normal timeout |
| **SQLite Cache** | Local cache using `call-log-json-cache.db3` |

---

## Database Architecture

CDRMunch interacts with multiple databases:

### Queue Database (QueueDB)
- MariaDB-based queue management
- Stores CDR processing queue entries
- Task queue for executors
- Master-master replication between SDCs

### CDR Database (CDRDB)
- Stores normalized CDR data
- Read-only replicas for reporting
- Historical call data

### Billing Database
- Billing-specific CDR aggregations
- Wholesale billing records

### LCR Database (read-only)
- Least Cost Routing data
- Carrier rate information

**Configuration Files:**
```
/etc/cdrmunch/conf.d/
├── database.conf           # Primary database
├── database_cdrdb.conf     # CDR database
├── database_cdrdb_ro.conf  # CDR read-only
├── database_lcrdb_ro.conf  # LCR read-only
├── database_billing.conf   # Billing database
└── database_logs.conf      # Logs database
```

---

## Task Types and Processing

### Task Categories

| Category | Tasks | Description |
|----------|-------|-------------|
| **Notifications** | SendEmail, SendSMS | User notifications |
| **Voicemail** | NotifyVoicemailViaEmail, NotifyVoicemailViaSMS | VM delivery |
| **Recording** | EmailRecording, BufferedRecording | Recording delivery |
| **Analytics** | CallAnalysis, LogActivity | Data analysis |
| **Billing** | BillingFeed, WholesaleBilling | Financial data |
| **Salesforce** | CDR2SGAPI, SalesForceStore | CRM integration |

### Task Lifecycle

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Pending   │───▶│  Processing │───▶│  Complete   │    │   Failed    │
└─────────────┘    └──────┬──────┘    └─────────────┘    └──────▲──────┘
                         │                                      │
                         └──────────── Retry ───────────────────┘
```

**Exception Handling:**
- `IgnorableFailureException` - Non-critical failures
- `PermanentFailureException` - No retry needed
- `RetriableFailureException` - Will be retried
- `VoicemailTooBigException` - Size limit exceeded

---

## Deployment Architecture

### Current Deployment (SDC-based)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           SDC (Data Center)                              │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────┐         ┌─────────────────┐                        │
│   │   PBX Cluster   │────────▶│   CDR Host      │                        │
│   │   (FreeSWITCH)  │  CDRs   │                 │                        │
│   └─────────────────┘         │   • ArchiveD    │                        │
│                               │   • CDRMunch    │                        │
│                               │   • Gateway     │                        │
│                               │   • Distiller   │                        │
│                               │   • Executors   │                        │
│                               └────────┬────────┘                        │
│                                        │                                 │
│                                        ▼                                 │
│                               ┌─────────────────┐                        │
│                               │   MariaDB       │◀───────────────┐       │
│                               │   (QueueDB)     │                │       │
│                               └─────────────────┘      Replication       │
│                                                                  │       │
│   ┌─────────────────┐                                            │       │
│   │   SDC 2         │────────────────────────────────────────────┘       │
│   │   (Standby)     │                                                    │
│   └─────────────────┘                                                    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### RT (Cloud) Deployment Pattern

With RT regions, PCP services are deployed closer to call origination:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RT Region (AWS)                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────┐         ┌─────────────────────────────────────┐   │
│   │   PBX (EC2)     │────────▶│   PCP Services                      │   │
│   │                 │         │   • CDRMunch                         │   │
│   └─────────────────┘         │   • Task Executors                   │   │
│                               └───────────────┬─────────────────────┘   │
│                                               │                         │
│                                               ▼                         │
│                               ┌─────────────────────────────────────┐   │
│                               │   Aurora Serverless MySQL           │   │
│                               │   (Queue Management)                │   │
│                               └─────────────────────────────────────┘   │
│                                               │                         │
│                                               ▼                         │
│                               ┌─────────────────────────────────────┐   │
│                               │   S3 (Recordings, CDR, PCAP)        │   │
│                               └─────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Future Architecture: PCP Rearchitecture

The PCP system is undergoing a significant rearchitecture to become AWS-native and event-driven. Key changes include:

### Phase 1: Core Changes

1. **Event-Driven Processing** - Replace monolithic CDRMunch with decoupled AWS services (Lambda, SQS, EventBridge)

2. **Home Region Storage** - Per-customer S3 buckets in their designated Home Region with SSE-S3 encryption

3. **Notification Migration** - Move Email/SMS notifications to dedicated AWS services (SES for email)

4. **Call Analysis Integration** - Direct S3-to-S3 integration for transcription pipeline

5. **CRO Generation** - Events consumed by External Event Service for Salesforce integration

### Key Migration Tasks

| Legacy Component | New Approach |
|------------------|--------------|
| CDRMunch Distiller | Lambda + SQS event processing |
| Task Executor | Dedicated Lambda functions |
| Hurler | Direct S3 integration with Call Analysis |
| MariaDB Queue | SQS + DynamoDB |
| Archive Storage | Per-customer S3 buckets |

### Retention Management

- S3 lifecycle policies replace legacy retention rules
- Tag-based retention using `retentionRuleId`
- Per-customer bucket lifecycle configuration
- BYOS3 option for customer-managed storage

---

## Operations

### Service Management

```bash
# Check service status
systemctl status rmdistiller rmcdrgateway cdrmunch-task-executor

# View logs
journalctl -u rmdistiller -f
journalctl -u cdrmunch-task-executor -f

# Restart services
systemctl restart rmdistiller
```

### Log Files

| Service | Log Location |
|---------|--------------|
| Distiller | `/var/log/cdrmunch/` (via syslog) |
| Gateway | `/var/log/cdrmunch/` (via syslog) |
| Task Executor | Syslog facility local5 |

**RSyslog Configuration:**
- `/etc/rsyslog.d/11-rmdistiller.conf`
- `/etc/rsyslog.d/11-rmcdrgateway.conf`
- `/etc/rsyslog.d/11-rmhurler.conf`
- `/etc/rsyslog.d/12-cdrmunch-tasks.conf`

### Monitoring

**Key Metrics:**
- CDR queue depth
- Task processing rate
- Failed task count
- Distiller thread utilization
- S3 upload success rate

**Alerting Scenarios:**
- Queue backlog exceeding threshold
- Task failure rate increase
- Service unavailability
- Database connection issues

### Common Issues

| Issue | Cause | Resolution |
|-------|-------|------------|
| Queue backlog | Distiller overload | Increase distillery threads |
| Task failures | Dependency unavailable | Check CoreAPI, Salesforce connectivity |
| S3 upload failures | Credentials/connectivity | Verify AWS credentials and network |
| Email delivery failures | MTA issues | Check SES/MTA configuration |

---

## Key Repositories

| Repository | Description | Language |
|------------|-------------|----------|
| `platform-cdrmunch` | CDR processing components | C++/PHP |
| `platform-archiving` | Policy-based archiving | C++ |
| `platform-workflow-engine` | CDR to Service Gateway API | PHP |
| `go-cdr-import` | CDR import utility | Go |

---

## Configuration Reference

### Main Packages (RPM)

| Package | Contents |
|---------|----------|
| `RM-cdrmunch` | Distiller core |
| `RM-cdrmunch-gateway` | CDR Gateway |
| `RM-cdrmunch-cron` | Task executors |
| `RM-cdrmunch-hurler` | Call analysis hurler |
| `RM-cdrmunch-phplib` | PHP libraries |
| `RM-cdrmunch-common` | Shared configuration |
| `RM-cdrmunch-scripts` | Utility scripts |

### System User

```bash
# CDRMunch runs as dedicated user
User: cdrmunch (UID 134)
Group: cdrmunch (GID 134)
Home: /var/log/cdrmunch
```

### Directory Structure

```
/etc/cdrmunch/           # Configuration
/var/log/cdrmunch/       # Logs
/var/spool/cdrtmp/       # Working directories
  ├── cdrmunch-normalized-cdr/
  └── cdrmunch-cache/
/usr/share/cdrmunch/     # Shared resources
/usr/share/php/cdrmunch/ # PHP libraries
```

---

## Related Documentation

- [Voice Routing Overview](./overview.md)
- [fsxinetd Service](./fsxinetd.md)
- [Database Architecture](../database/overview.md)
- [Platform API](../../services/platform-core/platform-api.md)

---

## Source References

- Confluence: [Post Call Processing Services](https://natterbox.atlassian.net/wiki/spaces/df/pages/1269465093/Post+Call+Processing+Services)
- Confluence: [PCP Rearchitecture Design v2.1](https://natterbox.atlassian.net/wiki/spaces/df/pages/2333671486/PCP+Rearchitecture+Design+v2.1)
- GitHub: [platform-cdrmunch](https://github.com/redmatter/platform-cdrmunch)
- GitHub: [platform-archiving](https://github.com/redmatter/platform-archiving)

---

*Migrated from Confluence Design Space - Post Call Processing Services*
