# CDRMunch - Call Detail Record Processing Pipeline

> **Last Updated**: 2026-01-20  
> **Status**: Production  
> **Repository**: [platform-cdrmunch](https://github.com/redmatter/platform-cdrmunch)  
> **Language**: C++ (core), with supporting services

## Overview

CDRMunch is Natterbox's **Post-Call Processing (PCP)** system responsible for processing Call Detail Records (CDRs) generated by FreeSWITCH. It handles CDR normalization, task generation, billing data extraction, and various post-call operations like recording delivery and Salesforce synchronization.

### Key Responsibilities

| Function | Description |
|----------|-------------|
| **CDR Normalization** | Transform raw FreeSWITCH CDRs into normalized XML format |
| **Task Processing** | Generate and execute post-call tasks (billing, Salesforce sync, notifications) |
| **Recording Management** | Handle buffered recordings, delivery, and storage |
| **Billing Feed** | Extract billing data and feed to billing system |
| **Data Storage** | Store CDRs, normalized records, and metadata to database and S3 |

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           CDRMunch Architecture                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   FreeSWITCH                                                                     │
│       │                                                                          │
│       │ CDR XML Files                                                            │
│       ▼                                                                          │
│   ┌─────────────┐                                                                │
│   │   Hurler    │  ◄──── HTTP Gateway (receives CDRs from ArchiveD/CollectD)     │
│   │  (Gateway)  │        Port 80/443                                             │
│   └──────┬──────┘                                                                │
│          │                                                                       │
│          │ Writes to MySQL cdr_queue                                             │
│          ▼                                                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐       │
│   │                        CDR Database (MySQL)                          │       │
│   │  ┌─────────────┐  ┌──────────────────┐  ┌─────────────────────────┐ │       │
│   │  │  cdr_queue  │  │  normalized_cdrs │  │         tasks           │ │       │
│   │  │  (pending)  │  │   (processed)    │  │  (pending/completed)    │ │       │
│   │  └─────────────┘  └──────────────────┘  └─────────────────────────┘ │       │
│   └─────────────────────────────────────────────────────────────────────┘       │
│          │                         │                        │                    │
│          │ Polls                   │                        │ Polls              │
│          ▼                         │                        ▼                    │
│   ┌─────────────┐                  │                 ┌─────────────────┐         │
│   │  Distiller  │──────────────────┼────────────────►│  Task Executor  │         │
│   │   (main)    │  Produces        │                 │    (tasksd)     │         │
│   │             │  normalized CDR  │                 │                 │         │
│   │  ┌────────┐ │  + tasks         │                 │  Executes:      │         │
│   │  │Worker 1│ │                  │                 │  - Billing      │         │
│   │  │Worker 2│ │                  │                 │  - CDR2SFAPI    │         │
│   │  │Worker 3│ │                  │                 │  - Recording    │         │
│   │  │  ...   │ │                  │                 │  - Email notify │         │
│   │  │Worker N│ │                  │                 │  - SMS notify   │         │
│   │  └────────┘ │                  │                 └─────────────────┘         │
│   └─────────────┘                  │                          │                  │
│          │                         │                          │                  │
│          │ Normalized CDR          │                          │                  │
│          │ XML files               │                          │                  │
│          ▼                         │                          ▼                  │
│   ┌─────────────────────────────────────────────────────────────────────┐       │
│   │                         S3 / Local Storage                          │       │
│   │   - Normalized CDR XML files                                        │       │
│   │   - Call recordings                                                 │       │
│   │   - Transcriptions                                                  │       │
│   └─────────────────────────────────────────────────────────────────────┘       │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐       │
│   │                      Supporting Services                            │       │
│   │   ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │       │
│   │   │Billing Feeder│  │   Emailer    │  │        Gateway           │ │       │
│   │   │(extract bill │  │ (send notif) │  │  (legacy HTTP endpoint)  │ │       │
│   │   │ data)        │  │              │  │                          │ │       │
│   │   └──────────────┘  └──────────────┘  └──────────────────────────┘ │       │
│   └─────────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Components

### 1. Hurler (HTTP Gateway)

The HTTP endpoint that receives CDR data from ArchiveD/CollectD running on FreeSWITCH hosts.

**Source**: `hurler/main.cpp`

#### Configuration (`hurler/rmhurler.conf`)

```ini
# HTTP Server settings
server.address = 0.0.0.0
server.port = 80

# Server threads
server.threads = 4

# Content length limits
server.max_content_length = 2147483648  # 2GB max

# Request handler settings
request_handler.cdr_queue_enabled = true
request_handler.cdr_base_dir = /data/PBX_Archive/CDR
request_handler.paging_base_dir = /data/PBX_Archive/SMS
request_handler.pcap_base_dir = /data/PBX_Archive/PCAP

# Database connection
@require = conf.d/database_cdrdb.conf

# Logging
log.level@prod = 4
log.level = 6
log.facility@prod = daemon
```

#### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/v2/cdr` | POST | Submit CDR for processing |
| `/api/v2/paging` | POST | Submit SMS/paging record |
| `/api/v2/pcap` | POST | Submit PCAP capture |
| `/health` | GET | Health check endpoint |

### 2. Distiller (CDR Processor)

The main CDR processing engine. Written in C++, it polls the `cdr_queue` table, processes raw CDRs through the `rmdistillery` binary, and generates normalized CDR XML plus associated tasks.

**Source**: `distiller/main.cpp`, `distiller/distillery/distillery.hpp`

#### Processing Flow

```
1. Poll cdr_queue for pending CDRs
2. Load raw CDR XML from filesystem
3. Send to rmdistillery child process for normalization
4. Receive normalized CDR XML
5. Store normalized CDR to filesystem (time-based directories)
6. Insert record to normalized_cdrs table
7. Generate tasks based on CDR content (billing, SF sync, etc.)
8. Insert tasks to tasks table
9. Update cdr_queue status (done='y' on success)
```

#### Configuration (`distiller/distiller.conf`)

```ini
# Number of worker threads (distilleries)
distiller.number_of_distilleries = 10

# CDR Queue polling settings
cdr_queue_poll_interval_seconds = 1
cdr_queue_poll_max_batch_size = 1000

# File paths
cdr_base_dir = /data/PBX_Archive/CDR
normalized_cdr_base_dir = /data/CDRMunch/ncdr

# Tasks that should NOT be generated
disabled_tasks = 

# Process settings
app.pid_file = /var/run/cdrmunch/cdrmunch-distiller.pid
app.memory_limit = 8M
app.run_as_user = cdrmunch
app.run_as_group = cdrmunch

# Database
@require = conf.d/database_cdrdb.conf

# Logging (1=critical, 2=error, 3=warning, 4=message, 5=verbose, 6=debug)
log.level@prod = 4
log.level = 6
log.facility@prod = daemon
```

#### Processing Outcomes

From `distillery.hpp`:

| Outcome | Description | Action |
|---------|-------------|--------|
| `outcome_successful` | CDR processed successfully | Mark done='y' |
| `outcome_successful_duplicate` | Duplicate detected | Mark done='y' (skip) |
| `outcome_permanent_failure` | Bad XML, cannot recover | Mark done='error' |
| `outcome_retriable_failure` | Temporary failure | Retry with backoff |
| `outcome_internal_failure` | Distillery process issue | Restart distillery, retry soon |

### 3. Task Executor (tasksd)

Polls the `tasks` table and executes post-call processing tasks. Each task type has a specific handler.

**Source**: `tasksd/tasksd.conf`, `cpp-common/task_type.hpp`

#### Task Types

From `cpp-common/task_type.hpp`:

```cpp
enum task_type_t {
    task_unknown = 0,
    task_bufferedRecording,    // Process buffered recordings
    task_CDR2SF,               // Sync CDR to Salesforce (deprecated)
    task_SMSSend,              // Send SMS notifications
    task_billing,              // Feed billing system
    task_emailer,              // Send email notifications
    task_calllog,              // Generate call log entries
    task_CDR2SFAPI,            // Sync CDR to Salesforce via API
    task_recordingDelivery,    // Deliver recordings
    task_transcription,        // Queue for transcription

    n_task_type
};
```

#### Configuration (`tasksd/tasksd.conf`)

```ini
# Worker threads per task type
executor.threads@prod = 5
executor.threads = 2

# Polling interval
tasksd.poll_interval_seconds = 1
tasksd.poll_batch_size = 100

# Retry settings
tasksd.max_retries = 5
tasksd.retry_backoff_seconds = 60

# Task handlers configuration
tasksd.handler.billing = billing-feeder
tasksd.handler.emailer = emailer
tasksd.handler.CDR2SFAPI = cdr2sfapi

# Database
@require = conf.d/database_cdrdb.conf

# Process settings
app.pid_file = /var/run/cdrmunch/cdrmunch-tasksd.pid
app.memory_limit = 8M
app.run_as_user = cdrmunch

# Logging
log.level@prod = 4
log.level = 6
```

### 4. Billing Feeder

Extracts billing data from normalized CDRs and feeds the billing system.

**Configuration (`billing-feeder/billing-feeder.conf`)**

```ini
# Fields extracted from normalized CDR for billing
billing-feeder.field_names = uuid,quantity,rmOriginatorOrgId,rmOriginatorUserId,retailConnectCharge,retailRate,retailRateType,retailCountryCode,retailCountry,retailPrimaryBandType,retailSubBandType,retailChargeBand,rmOriginatedExternal,sip_to_user,answer_epoch,answer_stamp,end_epoch,end_stamp,originator_username,lcr_carrier,lcr_rate,billingEventType

# Field types (s=string, d=decimal/number)
billing-feeder.field_types = s,d,d,d,d,d,s,s,s,s,s,s,s,s,d,s,d,s,s,s,d,s

# Field name mappings
billing-feeder.node_name_map__billsec = quantity

# Database connections
@require = conf.d/database_cdrdb.conf
@require = conf.d/database_billing.conf
```

### 5. Task Executor (`task-executor`)

Generic task execution framework.

**Configuration (`task-executor/task-executor.conf`)**

```ini
# Worker configuration
task-executor.workers = 10
task-executor.poll_interval = 1

# Task queue
task-executor.queue_table = CDR.tasks
task-executor.status_field = done
task-executor.type_field = task_type

# Retry configuration
task-executor.max_retries = 5
task-executor.retry_delay_seconds = 60
task-executor.exponential_backoff = true

# Database
@require = conf.d/database_cdrdb.conf

# Process settings
app.pid_file = /var/run/cdrmunch/task-executor.pid
app.run_as_user = cdrmunch
```

## Database Schema

### CDR Database Tables

#### `cdr_queue`
Raw CDRs waiting for processing:

```sql
CREATE TABLE `cdr_queue` (
    `id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `uuid` BINARY(16) NOT NULL,
    `freeswitch_host` VARCHAR(255) NOT NULL,
    `path` VARCHAR(1024) NOT NULL,
    `create_time` INT UNSIGNED NOT NULL,
    `done` ENUM('n', 'y', 'error') DEFAULT 'n',
    `next_attempt` DATETIME,
    `retry` INT UNSIGNED DEFAULT 0,
    UNIQUE KEY `idx_uuid` (`uuid`),
    KEY `idx_done_next_attempt` (`done`, `next_attempt`)
);
```

#### `normalized_cdrs`
Processed/normalized CDR records:

```sql
CREATE TABLE `normalized_cdrs` (
    `id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `uuid` BINARY(16) NOT NULL,
    `path` VARCHAR(1024) NOT NULL,      -- Path to normalized XML
    `cdr_path` VARCHAR(1024),           -- Path to original CDR
    `TableSuffix` INT NOT NULL,         -- Date partition (YYYYMMDD)
    `rmOrgID` INT NOT NULL,             -- Organization ID
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY `idx_uuid` (`uuid`),
    KEY `idx_org_suffix` (`rmOrgID`, `TableSuffix`)
);
```

#### `tasks`
Post-processing tasks queue:

```sql
CREATE TABLE `tasks` (
    `id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `id_normalized_cdrs` BIGINT UNSIGNED NOT NULL,
    `task_type` VARCHAR(50) NOT NULL,
    `create_time` DATETIME NOT NULL,
    `next_attempt` DATETIME NOT NULL,
    `retry` INT UNSIGNED DEFAULT 0,
    `done` ENUM('n', 'y', 'error') DEFAULT 'n',
    `node_index` INT UNSIGNED DEFAULT 0,
    `error_message` TEXT,
    KEY `idx_type_done_next` (`task_type`, `done`, `next_attempt`),
    FOREIGN KEY (`id_normalized_cdrs`) REFERENCES `normalized_cdrs`(`id`)
);
```

#### `cdr_queue_error`
Error tracking for failed CDR processing:

```sql
CREATE TABLE `cdr_queue_error` (
    `id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `id_cdr_queue` BIGINT UNSIGNED NOT NULL,
    `description` TEXT,
    `critical` ENUM('n', 'y') DEFAULT 'n',
    `first_error_date` DATETIME,
    `last_error_date` DATETIME,
    UNIQUE KEY `idx_cdr_queue` (`id_cdr_queue`)
);
```

## Data Flow

### CDR Processing Pipeline

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         CDR Processing Timeline                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  T+0s     │ Call ends on FreeSWITCH                                          │
│           │ CDR XML written to disk                                          │
│           ▼                                                                   │
│  T+1s     │ ArchiveD/CollectD detects new CDR                                │
│           │ Sends CDR to Hurler via HTTP POST                                │
│           ▼                                                                   │
│  T+2s     │ Hurler validates and stores CDR file                             │
│           │ Inserts record into cdr_queue                                    │
│           ▼                                                                   │
│  T+3s     │ Distiller polls cdr_queue                                        │
│           │ Picks up CDR for processing                                      │
│           ▼                                                                   │
│  T+4s     │ rmdistillery normalizes CDR                                      │
│           │ - Extracts call metadata                                         │
│           │ - Determines billing info                                        │
│           │ - Identifies required tasks                                      │
│           ▼                                                                   │
│  T+5s     │ Distiller stores normalized CDR                                  │
│           │ - XML to /data/CDRMunch/ncdr/{YYYYMMDDTHH00}/{uuid}.xml          │
│           │ - Record to normalized_cdrs table                                │
│           │ - Tasks to tasks table                                           │
│           ▼                                                                   │
│  T+6s     │ Task Executor picks up tasks                                     │
│           │ - billing: Feed billing system                                   │
│           │ - CDR2SFAPI: Sync to Salesforce                                  │
│           │ - emailer: Send notifications                                    │
│           │ - transcription: Queue for transcription                         │
│           ▼                                                                   │
│  T+10s+   │ All tasks completed                                              │
│           │ CDR fully processed                                              │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Normalized CDR Structure

The normalized CDR XML contains structured data extracted from raw FreeSWITCH CDR:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<cdr-normalized>
    <data>
        <uuid record="true">12345678-1234-1234-1234-123456789abc</uuid>
        <TableSuffix record="true">1737331200</TableSuffix>
        <rmOrgID record="true">12345</rmOrgID>
        
        <!-- Call metadata -->
        <direction>outbound</direction>
        <caller_id_number>+441onal234567</caller_id_number>
        <destination_number>+442071234567</destination_number>
        <answer_epoch>1737331245</answer_epoch>
        <end_epoch>1737331545</end_epoch>
        <billsec>300</billsec>
        
        <!-- Billing data -->
        <retailConnectCharge>0.01</retailConnectCharge>
        <retailRate>0.02</retailRate>
        <retailRateType>perMinute</retailRateType>
        <retailCountryCode>GB</retailCountryCode>
        
        <!-- Recording info -->
        <recording_path>/data/recordings/2026/01/20/uuid.wav</recording_path>
    </data>
    
    <tasks>
        <task type="billing">
            <quantity>5</quantity>
            <rate>0.02</rate>
        </task>
        <task type="CDR2SFAPI">
            <sf_org_id>00D1234567</sf_org_id>
        </task>
        <task type="transcription">
            <CDRFilePath>__CDRFilePath__</CDRFilePath>
        </task>
    </tasks>
</cdr-normalized>
```

## Deployment

### Service Architecture

CDRMunch services currently run on dedicated "CDR boxes" in SDCs (Secure Data Centers). The architecture is being migrated to AWS for better scalability.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Current Deployment (SDC)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   SDC-A (Active)                    SDC-B (Standby)                         │
│   ┌─────────────────────┐           ┌─────────────────────┐                 │
│   │     CDR Box         │           │     CDR Box         │                 │
│   │                     │           │                     │                 │
│   │  - Hurler           │           │  - Hurler           │                 │
│   │  - Distiller        │◄─────────►│  - Distiller        │                 │
│   │  - Tasksd           │  MariaDB  │  - Tasksd           │                 │
│   │  - Billing Feeder   │  Master-  │  - Billing Feeder   │                 │
│   │  - Emailer          │  Master   │  - Emailer          │                 │
│   │                     │  Repl.    │                     │                 │
│   └─────────────────────┘           └─────────────────────┘                 │
│                                                                              │
│   - Auto-increment offset based queue sharing                               │
│   - Local filesystem for CDR storage                                        │
│   - Single host per SDC limitation                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### AWS Migration (In Progress)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Target Deployment (AWS RT)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   RT Region (e.g., eu-west-2)                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Global PCP Services                             │   │
│   │                                                                      │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │   │
│   │   │  Hurler ECS │  │  Distiller  │  │   Tasksd    │                 │   │
│   │   │   Cluster   │  │     ECS     │  │     ECS     │                 │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                 │   │
│   │          │                │                │                         │   │
│   │          └────────────────┼────────────────┘                         │   │
│   │                           │                                          │   │
│   │                           ▼                                          │   │
│   │                 ┌─────────────────────┐                              │   │
│   │                 │  Aurora Serverless  │                              │   │
│   │                 │      MySQL          │                              │   │
│   │                 └─────────────────────┘                              │   │
│   │                                                                      │   │
│   │   Storage:                                                           │   │
│   │   ┌─────────────┐  ┌─────────────┐                                  │   │
│   │   │  S3 (CDRs,  │  │    EFS      │                                  │   │
│   │   │ Recordings) │  │  (temp)     │                                  │   │
│   │   └─────────────┘  └─────────────┘                                  │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   Benefits:                                                                  │
│   - Horizontal scalability                                                  │
│   - No cross-region data transfer costs                                     │
│   - Data residency compliance                                               │
│   - Auto-scaling based on load                                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Configuration Reference

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `CDRMUNCH_CONFIG_DIR` | `/etc/cdrmunch` | Configuration directory |
| `CDRMUNCH_DATA_DIR` | `/data/CDRMunch` | Data storage directory |
| `CDRMUNCH_LOG_DIR` | `/var/log/cdrmunch` | Log directory |
| `CDRMUNCH_RUN_DIR` | `/var/run/cdrmunch` | PID files directory |

### Distiller Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `distiller.number_of_distilleries` | 10 | Number of worker threads |
| `cdr_queue_poll_interval_seconds` | 1 | Queue polling interval |
| `cdr_queue_poll_max_batch_size` | 1000 | Max CDRs per poll cycle |
| `cdr_base_dir` | `/data/PBX_Archive/CDR` | Raw CDR storage location |
| `normalized_cdr_base_dir` | `/data/CDRMunch/ncdr` | Normalized CDR output |
| `disabled_tasks` | (empty) | Comma-separated list of tasks to skip |

### Hurler Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `server.address` | `0.0.0.0` | Listen address |
| `server.port` | 80 | Listen port |
| `server.threads` | 4 | HTTP server threads |
| `server.max_content_length` | 2147483648 | Max upload size (2GB) |
| `request_handler.cdr_queue_enabled` | true | Enable CDR queue insertion |
| `request_handler.cdr_base_dir` | `/data/PBX_Archive/CDR` | CDR storage location |

### Task Executor Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `executor.threads` | 5 (prod), 2 (dev) | Worker threads |
| `tasksd.poll_interval_seconds` | 1 | Task polling interval |
| `tasksd.poll_batch_size` | 100 | Tasks per poll cycle |
| `tasksd.max_retries` | 5 | Maximum retry attempts |
| `tasksd.retry_backoff_seconds` | 60 | Retry delay |

## Monitoring

### Key Metrics

| Metric | Description | Alert Threshold |
|--------|-------------|-----------------|
| `cdr_queue_pending` | CDRs awaiting processing | > 10000 |
| `cdr_queue_errors` | CDRs in error state | > 100 |
| `tasks_pending` | Tasks awaiting execution | > 50000 |
| `tasks_errors` | Failed tasks | > 500 |
| `distiller_throughput` | CDRs processed/minute | < 100 |
| `task_latency_p99` | 99th percentile task time | > 30s |

### Health Checks

```bash
# Hurler health
curl http://localhost:80/health

# Check queue depth
mysql -e "SELECT done, COUNT(*) FROM CDR.cdr_queue GROUP BY done"

# Check task backlog
mysql -e "SELECT task_type, done, COUNT(*) FROM CDR.tasks GROUP BY task_type, done"

# Check for stuck CDRs (> 1 hour old, not done)
mysql -e "SELECT COUNT(*) FROM CDR.cdr_queue 
          WHERE done='n' AND create_time < UNIX_TIMESTAMP() - 3600"
```

### Log Locations

| Service | Log Path |
|---------|----------|
| Hurler | `/var/log/cdrmunch/hurler.log` |
| Distiller | `/var/log/cdrmunch/distiller.log` |
| Tasksd | `/var/log/cdrmunch/tasksd.log` |
| Billing Feeder | `/var/log/cdrmunch/billing-feeder.log` |

## Troubleshooting

### Common Issues

#### 1. CDRs Not Processing

**Symptoms**: Growing `cdr_queue` with `done='n'`

**Diagnosis**:
```bash
# Check distiller is running
ps aux | grep rmdistillery

# Check for errors
tail -f /var/log/cdrmunch/distiller.log | grep -i error

# Check database connectivity
mysql -e "SELECT 1 FROM CDR.cdr_queue LIMIT 1"
```

**Resolution**:
- Restart distiller service
- Check MySQL connectivity
- Verify file permissions on CDR directories

#### 2. Tasks Failing

**Symptoms**: Tasks in `done='error'` state

**Diagnosis**:
```bash
# Identify failing tasks
mysql -e "SELECT task_type, COUNT(*) FROM CDR.tasks 
          WHERE done='error' GROUP BY task_type"

# Check task executor logs
grep "error" /var/log/cdrmunch/tasksd.log | tail -100
```

**Resolution**:
- Check external service connectivity (Salesforce, billing, email)
- Verify credentials and API limits
- Reset task for retry: `UPDATE tasks SET done='n', retry=0 WHERE id=...`

#### 3. Duplicate CDR Processing

**Symptoms**: `ER_DUP_ENTRY` errors in distiller log

**Root Cause**: Same CDR submitted multiple times (rare, usually after restart)

**Resolution**: 
- These are automatically handled - marked as `outcome_successful_duplicate`
- Check `cdr_queue` for duplicates if frequent

#### 4. Disk Space Issues

**Symptoms**: Write failures, slow processing

**Diagnosis**:
```bash
df -h /data/CDRMunch
du -sh /data/CDRMunch/ncdr/*
```

**Resolution**:
- Archive old normalized CDRs to S3
- Check purge process is running
- Increase disk allocation

## Dependencies

### Internal Services

| Service | Purpose | Required |
|---------|---------|----------|
| FreeSWITCH | CDR source | Yes |
| ArchiveD/CollectD | CDR collection | Yes |
| CoreAPI | Customer data lookup | Yes |
| BigDB | Configuration data | Yes |
| Billing System | Usage billing | For billing tasks |
| Salesforce API | CRM sync | For SF tasks |

### External Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| MySQL/MariaDB | 5.7+ | Primary database |
| libmysqlclient | 5.7+ | MySQL C client |
| Boost | 1.65+ | C++ utilities |
| pugixml | 1.9+ | XML processing |
| libcurl | 7.x | HTTP client |

## Source Code References

| Component | Path | Description |
|-----------|------|-------------|
| Distiller main | `distiller/main.cpp` | Distiller entry point |
| Distillery core | `distiller/distillery/distillery.hpp` | CDR processing logic |
| Hurler main | `hurler/main.cpp` | HTTP gateway entry |
| Task types | `cpp-common/task_type.hpp` | Task type enumeration |
| CDR DB helpers | `cpp-common/database/cdrdb.hpp` | Database operations |
| Gateway handler | `gateway/request_handler.cpp` | HTTP request handling |

---

## Related Documentation

- [Post Call Processing Services (Confluence)](https://natterbox.atlassian.net/wiki/spaces/EN/pages/1269465093/Post+Call+Processing+Services)
- [ArchiveD Documentation](./archived.md) - CDR collection service
- [FreeSWITCH Integration](./freeswitch.md) - Call processing
- [Billing System](./billing.md) - Usage billing integration
